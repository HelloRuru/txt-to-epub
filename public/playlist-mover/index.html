<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Playlist Mover — 歌單搬家工具 | HelloRuru Tools</title>
  <meta name="description" content="把歌曲清單批量搬到 Spotify 歌單，貼上歌名就能用。">
  <script src="https://lab.helloruru.com/shared/brand-header.js"></script>
  <style>
    :root {
      --c-rose: #D4A5A5;
      --c-lavender: #B8A9C9;
      --c-ink: #2D2D2D;
      --c-bg: #FEFBF9;
      --c-card: #FFFFFF;
      --c-border: #E8E0DC;
      --c-success: #7DB87D;
      --c-warning: #E8A838;
      --c-error: #C97070;
      --radius: 16px;
      --shadow: 0 2px 12px rgba(0,0,0,0.06);
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'GenSenRounded', 'Noto Sans TC', sans-serif;
      background: var(--c-bg);
      color: var(--c-ink);
      min-height: 100vh;
      padding: 24px 16px 80px;
    }
    .container { max-width: 640px; margin: 0 auto; }
    h1 { font-size: 1.6rem; text-align: center; margin: 24px 0 8px; }
    .subtitle { text-align: center; color: #888; font-size: 0.9rem; margin-bottom: 28px; }

    .step {
      background: var(--c-card);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 24px;
      margin-bottom: 20px;
    }
    .step-header { display: flex; align-items: center; gap: 10px; margin-bottom: 16px; }
    .step-num {
      width: 32px; height: 32px; border-radius: 50%;
      background: linear-gradient(135deg, var(--c-rose), var(--c-lavender));
      color: #fff; display: flex; align-items: center; justify-content: center;
      font-weight: bold; font-size: 0.9rem; flex-shrink: 0;
    }
    .step-title { font-size: 1.05rem; font-weight: 600; }

    textarea {
      width: 100%; min-height: 180px;
      border: 2px solid var(--c-border); border-radius: 12px;
      padding: 14px; font-family: inherit; font-size: 0.92rem;
      line-height: 1.6; resize: vertical; transition: border-color 0.2s;
    }
    textarea:focus { outline: none; border-color: var(--c-rose); }
    textarea::placeholder { color: #BBB; }

    .input-row { display: flex; gap: 10px; margin-bottom: 12px; }
    .input-row label {
      font-size: 0.88rem; color: #666; min-width: 70px;
      display: flex; align-items: center;
    }
    input[type="text"] {
      flex: 1; border: 2px solid var(--c-border); border-radius: 10px;
      padding: 10px 14px; font-family: inherit; font-size: 0.92rem;
      transition: border-color 0.2s;
    }
    input[type="text"]:focus { outline: none; border-color: var(--c-rose); }

    .btn {
      display: inline-flex; align-items: center; justify-content: center; gap: 6px;
      padding: 12px 28px; border: none; border-radius: 12px;
      font-family: inherit; font-size: 0.95rem; font-weight: 600;
      cursor: pointer; transition: all 0.2s; width: 100%;
    }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; }
    .btn-primary {
      background: linear-gradient(135deg, var(--c-rose), var(--c-lavender)); color: #fff;
    }
    .btn-primary:hover:not(:disabled) {
      transform: translateY(-1px);
      box-shadow: 0 4px 16px rgba(212, 165, 165, 0.4);
    }
    .btn-spotify { background: #1DB954; color: #fff; }
    .btn-spotify:hover:not(:disabled) {
      background: #1ed760; transform: translateY(-1px);
      box-shadow: 0 4px 16px rgba(29, 185, 84, 0.3);
    }

    /* Cover upload */
    .cover-section { margin-bottom: 16px; }
    .cover-row { display: flex; align-items: center; gap: 14px; }
    .cover-preview {
      width: 80px; height: 80px; border-radius: 10px;
      background: var(--c-border); overflow: hidden;
      display: flex; align-items: center; justify-content: center;
      font-size: 0.7rem; color: #AAA; flex-shrink: 0;
      position: relative; cursor: pointer;
    }
    .cover-preview img {
      width: 100%; height: 100%; object-fit: cover;
    }
    .cover-preview-text { text-align: center; line-height: 1.3; }
    .cover-info { flex: 1; }
    .cover-info p { font-size: 0.8rem; color: #AAA; line-height: 1.4; }
    .cover-remove {
      font-size: 0.78rem; color: var(--c-error); cursor: pointer;
      text-decoration: underline; margin-top: 4px; display: inline-block;
    }
    #coverFileInput { display: none; }

    /* Results */
    .results { margin-top: 16px; }
    .result-item {
      display: flex; align-items: center; gap: 10px;
      padding: 10px 0; border-bottom: 1px solid var(--c-border); font-size: 0.88rem;
    }
    .result-item:last-child { border-bottom: none; }
    .result-status {
      width: 24px; height: 24px; border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      font-size: 0.75rem; flex-shrink: 0;
    }
    .result-status.found { background: #E8F5E8; color: var(--c-success); }
    .result-status.not-found { background: #FDE8E8; color: var(--c-error); }
    .result-original { color: #999; font-size: 0.8rem; }
    .result-match { font-weight: 500; }
    .result-info { flex: 1; min-width: 0; }
    .result-link { color: var(--c-rose); text-decoration: none; font-size: 0.8rem; }

    .progress-bar {
      width: 100%; height: 6px; background: var(--c-border);
      border-radius: 3px; overflow: hidden; margin: 12px 0;
    }
    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--c-rose), var(--c-lavender));
      border-radius: 3px; transition: width 0.3s; width: 0%;
    }
    .progress-text { font-size: 0.82rem; color: #999; text-align: center; }

    .summary { display: flex; gap: 16px; margin: 16px 0; }
    .summary-item {
      flex: 1; text-align: center; padding: 12px;
      border-radius: 12px; background: var(--c-bg);
    }
    .summary-num { font-size: 1.5rem; font-weight: 700; }
    .summary-label { font-size: 0.78rem; color: #999; margin-top: 2px; }
    .summary-item.found .summary-num { color: var(--c-success); }
    .summary-item.not-found .summary-num { color: var(--c-error); }
    .summary-item.total .summary-num { color: var(--c-lavender); }

    .hidden { display: none; }

    .status-msg {
      text-align: center; padding: 16px; border-radius: 12px;
      margin: 12px 0; font-size: 0.9rem;
    }
    .status-msg.success { background: #E8F5E8; color: #3D7A3D; }
    .status-msg.error { background: #FDE8E8; color: #8B3030; }

    .user-info {
      display: flex; align-items: center; gap: 10px;
      padding: 12px 16px; background: var(--c-bg);
      border-radius: 12px; margin-bottom: 16px;
    }
    .user-avatar {
      width: 36px; height: 36px; border-radius: 50%; background: var(--c-lavender);
    }
    .user-name { font-weight: 600; font-size: 0.9rem; }
    .user-logout {
      margin-left: auto; font-size: 0.8rem; color: #999;
      cursor: pointer; text-decoration: underline;
    }

    .hint { font-size: 0.8rem; color: #AAA; margin-top: 8px; line-height: 1.5; }
    .footer { text-align: center; margin-top: 40px; font-size: 0.78rem; color: #CCC; }
    .footer a { color: var(--c-rose); text-decoration: none; }
  </style>
</head>
<body>
  <div class="container">
    <h1>Playlist Mover</h1>
    <p class="subtitle">貼上歌曲清單，搬到 Spotify 歌單</p>

    <!-- Step 1: Login Spotify -->
    <div class="step" id="step1">
      <div class="step-header">
        <div class="step-num">1</div>
        <div class="step-title">登入 Spotify</div>
      </div>
      <div class="hidden" id="loginSection">
        <p style="font-size:0.9rem; color:#666; margin-bottom:12px;">登入你的 Spotify 帳號，歌單會建在你自己的帳號裡。</p>
        <button class="btn btn-spotify" onclick="loginSpotify()">登入 Spotify</button>
      </div>
      <div class="hidden" id="userSection">
        <div class="user-info">
          <img class="user-avatar" id="userAvatar" src="" alt="">
          <span class="user-name" id="userName"></span>
          <span class="user-logout" onclick="logoutSpotify()">登出</span>
        </div>
      </div>
    </div>

    <!-- Step 2: Paste songs -->
    <div class="step hidden" id="step2">
      <div class="step-header">
        <div class="step-num">2</div>
        <div class="step-title">貼上歌曲清單</div>
      </div>
      <div class="input-row">
        <label>歌單名稱</label>
        <input type="text" id="playlistName" value="" placeholder="例如：My Playlist">
      </div>

      <!-- Cover image upload -->
      <div class="cover-section">
        <div class="cover-row">
          <div class="cover-preview" id="coverPreview" onclick="document.getElementById('coverFileInput').click()">
            <div class="cover-preview-text" id="coverPreviewText">點擊上傳<br>歌單封面</div>
            <img id="coverImg" class="hidden" src="" alt="">
          </div>
          <div class="cover-info">
            <p>選填，正方形 JPEG/PNG，最大 256KB</p>
            <span class="cover-remove hidden" id="coverRemove" onclick="removeCover()">移除封面</span>
          </div>
        </div>
        <input type="file" id="coverFileInput" accept="image/jpeg,image/png" onchange="handleCoverUpload(event)">
      </div>

      <textarea id="songInput" placeholder="一行一首，格式：&#10;歌名 - 歌手&#10;歌名 / 歌手&#10;或只貼歌名也行&#10;&#10;範例：&#10;Shape of You - Ed Sheeran&#10;Blinding Lights - The Weeknd&#10;晴天 - 周杰倫"></textarea>
      <div class="hint">支援格式：「歌名 - 歌手」「歌名 / 歌手」「歌名, 歌手」或只有歌名</div>
      <br>
      <button class="btn btn-primary" id="btnSearch" onclick="startSearch()">搜尋 Spotify</button>
    </div>

    <!-- Step 3: Results + Create -->
    <div class="step hidden" id="step3">
      <div class="step-header">
        <div class="step-num">3</div>
        <div class="step-title">比對結果</div>
      </div>

      <div class="progress-bar" id="progressBar">
        <div class="progress-fill" id="progressFill"></div>
      </div>
      <div class="progress-text" id="progressText">搜尋中...</div>

      <div class="summary hidden" id="summary">
        <div class="summary-item total">
          <div class="summary-num" id="totalCount">0</div>
          <div class="summary-label">總共</div>
        </div>
        <div class="summary-item found">
          <div class="summary-num" id="foundCount">0</div>
          <div class="summary-label">找到</div>
        </div>
        <div class="summary-item not-found">
          <div class="summary-num" id="notFoundCount">0</div>
          <div class="summary-label">沒找到</div>
        </div>
      </div>

      <div class="results" id="resultsList"></div>

      <div class="hidden" id="createSection" style="margin-top:20px;">
        <button class="btn btn-spotify" id="btnCreate" onclick="createPlaylist()">建立歌單</button>
      </div>

      <div class="hidden" id="createStatus"></div>
    </div>

    <div class="footer">
      <a href="https://tools.helloruru.com">HelloRuru Tools</a>
    </div>
  </div>

  <script>
    // ===== Config =====
    const SPOTIFY_CLIENT_ID = '6311e9e594cd4b968047a6b60eed5b52';
    const REDIRECT_URI = 'https://tools.helloruru.com/playlist-mover/';
    const SCOPES = 'playlist-modify-public playlist-modify-private';

    // ===== State =====
    let accessToken = null;
    let spotifyUser = null;
    let matchedTracks = [];
    let coverBase64 = null; // base64 JPEG data (no prefix)

    // ===== PKCE helpers =====
    function generateRandomString(length) {
      const arr = new Uint8Array(length);
      crypto.getRandomValues(arr);
      return Array.from(arr, b => b.toString(16).padStart(2, '0')).join('').slice(0, length);
    }

    async function generateCodeChallenge(verifier) {
      const data = new TextEncoder().encode(verifier);
      const digest = await crypto.subtle.digest('SHA-256', data);
      return btoa(String.fromCharCode(...new Uint8Array(digest)))
        .replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, '');
    }

    // ===== Init =====
    window.addEventListener('DOMContentLoaded', async () => {
      const params = new URLSearchParams(window.location.search);
      const code = params.get('code');

      if (code) {
        // Exchange code for token (PKCE)
        const verifier = sessionStorage.getItem('pkce_verifier');
        if (verifier) {
          await exchangeCodeForToken(code, verifier);
          sessionStorage.removeItem('pkce_verifier');
          // Restore saved form data
          const saved = sessionStorage.getItem('pm_form');
          if (saved) {
            const form = JSON.parse(saved);
            document.getElementById('playlistName').value = form.name || '';
            document.getElementById('songInput').value = form.songs || '';
            sessionStorage.removeItem('pm_form');
          }
        }
        // Clean URL
        window.history.replaceState({}, '', window.location.pathname);
      }

      updateUI();
    });

    async function exchangeCodeForToken(code, verifier) {
      const res = await fetch('https://accounts.spotify.com/api/token', {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: new URLSearchParams({
          client_id: SPOTIFY_CLIENT_ID,
          grant_type: 'authorization_code',
          code: code,
          redirect_uri: REDIRECT_URI,
          code_verifier: verifier
        })
      });
      if (!res.ok) return;
      const data = await res.json();
      accessToken = data.access_token;
      await fetchSpotifyUser();
    }

    // ===== UI update =====
    function updateUI() {
      if (accessToken && spotifyUser) {
        document.getElementById('loginSection').classList.add('hidden');
        document.getElementById('userSection').classList.remove('hidden');
        document.getElementById('step2').classList.remove('hidden');
      } else {
        document.getElementById('loginSection').classList.remove('hidden');
        document.getElementById('userSection').classList.add('hidden');
        document.getElementById('step2').classList.add('hidden');
      }
    }

    // ===== Spotify OAuth (PKCE — no client_secret needed) =====
    async function loginSpotify() {
      // Save form data before redirect
      sessionStorage.setItem('pm_form', JSON.stringify({
        name: document.getElementById('playlistName').value,
        songs: document.getElementById('songInput').value
      }));

      const verifier = generateRandomString(128);
      sessionStorage.setItem('pkce_verifier', verifier);
      const challenge = await generateCodeChallenge(verifier);

      const params = new URLSearchParams({
        client_id: SPOTIFY_CLIENT_ID,
        response_type: 'code',
        redirect_uri: REDIRECT_URI,
        scope: SCOPES,
        code_challenge_method: 'S256',
        code_challenge: challenge,
        show_dialog: 'false'
      });
      window.location.href = `https://accounts.spotify.com/authorize?${params}`;
    }

    async function fetchSpotifyUser() {
      const res = await fetch('https://api.spotify.com/v1/me', {
        headers: { 'Authorization': `Bearer ${accessToken}` }
      });
      if (!res.ok) { accessToken = null; return; }
      spotifyUser = await res.json();
      document.getElementById('userName').textContent = spotifyUser.display_name || spotifyUser.id;
      const avatar = spotifyUser.images?.[0]?.url;
      if (avatar) document.getElementById('userAvatar').src = avatar;
    }

    function logoutSpotify() {
      accessToken = null;
      spotifyUser = null;
      coverBase64 = null;
      matchedTracks = [];
      document.getElementById('step3').classList.add('hidden');
      updateUI();
    }

    // ===== Cover image =====
    function handleCoverUpload(e) {
      const file = e.target.files[0];
      if (!file) return;

      if (file.size > 256 * 1024) {
        alert('圖片太大，最大 256KB');
        e.target.value = '';
        return;
      }

      const reader = new FileReader();
      reader.onload = () => {
        const dataUrl = reader.result;
        // Show preview
        document.getElementById('coverImg').src = dataUrl;
        document.getElementById('coverImg').classList.remove('hidden');
        document.getElementById('coverPreviewText').classList.add('hidden');
        document.getElementById('coverRemove').classList.remove('hidden');

        // Convert to JPEG base64 via canvas
        const img = new Image();
        img.onload = () => {
          const canvas = document.createElement('canvas');
          const size = Math.min(img.width, img.height);
          canvas.width = 300;
          canvas.height = 300;
          const ctx = canvas.getContext('2d');
          // Center crop to square
          const sx = (img.width - size) / 2;
          const sy = (img.height - size) / 2;
          ctx.drawImage(img, sx, sy, size, size, 0, 0, 300, 300);
          // Get base64 JPEG (no data:image/jpeg;base64, prefix)
          coverBase64 = canvas.toDataURL('image/jpeg', 0.9).split(',')[1];
        };
        img.src = dataUrl;
      };
      reader.readAsDataURL(file);
    }

    function removeCover() {
      coverBase64 = null;
      document.getElementById('coverImg').classList.add('hidden');
      document.getElementById('coverImg').src = '';
      document.getElementById('coverPreviewText').classList.remove('hidden');
      document.getElementById('coverRemove').classList.add('hidden');
      document.getElementById('coverFileInput').value = '';
    }

    // ===== Parse songs =====
    function parseSongs(text) {
      return text.split('\n')
        .map(line => line.trim())
        .filter(line => line.length > 0 && !/^\d+\.\s*$/.test(line))
        .map(line => {
          // Remove leading "1." "2." etc
          line = line.replace(/^\d+[\.\)]\s*/, '');

          let match = line.match(/^(.+?)\s*[-–—]\s*(.+)$/);
          if (match) return { title: match[1].trim(), artist: match[2].trim() };

          match = line.match(/^(.+?)\s*\/\s*(.+)$/);
          if (match) return { title: match[1].trim(), artist: match[2].trim() };

          match = line.match(/^(.+?)\s*,\s*(.+)$/);
          if (match) return { title: match[1].trim(), artist: match[2].trim() };

          return { title: line, artist: '' };
        });
    }

    // ===== Spotify Search =====
    async function searchSpotify(title, artist) {
      const query = artist ? `${title} ${artist}` : title;
      const url = `https://api.spotify.com/v1/search?q=${encodeURIComponent(query)}&type=track&limit=5`;

      const res = await fetch(url, {
        headers: { 'Authorization': `Bearer ${accessToken}` }
      });
      if (!res.ok) return null;

      const data = await res.json();
      const tracks = data.tracks?.items;
      if (!tracks || tracks.length === 0) return null;

      const t = tracks[0];
      return {
        uri: t.uri,
        name: t.name,
        artist: t.artists.map(a => a.name).join(', '),
        url: t.external_urls.spotify
      };
    }

    // ===== Search Flow =====
    async function startSearch() {
      const input = document.getElementById('songInput').value;
      const songs = parseSongs(input);
      if (songs.length === 0) return;

      document.getElementById('step3').classList.remove('hidden');
      document.getElementById('summary').classList.add('hidden');
      document.getElementById('createSection').classList.add('hidden');
      document.getElementById('createStatus').classList.add('hidden');
      document.getElementById('resultsList').innerHTML = '';
      matchedTracks = [];

      const progressFill = document.getElementById('progressFill');
      const progressText = document.getElementById('progressText');
      const btnSearch = document.getElementById('btnSearch');
      btnSearch.disabled = true;
      progressFill.style.width = '0%';

      let found = 0, notFound = 0;

      for (let i = 0; i < songs.length; i++) {
        const song = songs[i];
        const pct = ((i + 1) / songs.length * 100).toFixed(0);
        progressFill.style.width = pct + '%';
        progressText.textContent = `搜尋中... ${i + 1} / ${songs.length}`;

        const result = await searchSpotify(song.title, song.artist);
        const item = {
          query: song.artist ? `${song.title} - ${song.artist}` : song.title,
          spotifyUri: result?.uri || null,
          spotifyName: result?.name || null,
          spotifyArtist: result?.artist || null,
          spotifyUrl: result?.url || null
        };
        matchedTracks.push(item);

        if (result) { found++; appendResult(item, true); }
        else { notFound++; appendResult(item, false); }
      }

      progressText.textContent = '搜尋完成';
      document.getElementById('summary').classList.remove('hidden');
      document.getElementById('totalCount').textContent = songs.length;
      document.getElementById('foundCount').textContent = found;
      document.getElementById('notFoundCount').textContent = notFound;
      btnSearch.disabled = false;

      if (found > 0) {
        document.getElementById('createSection').classList.remove('hidden');
      }
    }

    function appendResult(item, isFound) {
      const div = document.createElement('div');
      div.className = 'result-item';
      if (isFound) {
        div.innerHTML = `
          <div class="result-status found">&#10003;</div>
          <div class="result-info">
            <div class="result-match">${esc(item.spotifyName)} — ${esc(item.spotifyArtist)}</div>
            <div class="result-original">${esc(item.query)}</div>
          </div>
          <a class="result-link" href="${esc(item.spotifyUrl)}" target="_blank">開啟</a>`;
      } else {
        div.innerHTML = `
          <div class="result-status not-found">&#10007;</div>
          <div class="result-info">
            <div class="result-match" style="color:#999">${esc(item.query)}</div>
            <div class="result-original">在 Spotify 找不到</div>
          </div>`;
      }
      document.getElementById('resultsList').appendChild(div);
    }

    function esc(str) {
      const d = document.createElement('div');
      d.textContent = str || '';
      return d.innerHTML;
    }

    // ===== Create Playlist =====
    async function createPlaylist() {
      if (!accessToken || !spotifyUser) return;

      const btnCreate = document.getElementById('btnCreate');
      const statusDiv = document.getElementById('createStatus');
      btnCreate.disabled = true;
      statusDiv.classList.remove('hidden');
      statusDiv.className = 'status-msg';
      statusDiv.textContent = '建立中...';

      const playlistName = document.getElementById('playlistName').value || 'My Playlist';
      const uris = matchedTracks.filter(t => t.spotifyUri).map(t => t.spotifyUri);

      if (uris.length === 0) {
        statusDiv.className = 'status-msg error';
        statusDiv.textContent = '沒有可加入的歌曲';
        btnCreate.disabled = false;
        return;
      }

      try {
        // 1. Create playlist
        const createRes = await fetch('https://api.spotify.com/v1/me/playlists', {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${accessToken}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            name: playlistName,
            description: '由 Playlist Mover (HelloRuru Tools) 建立',
            public: false
          })
        });
        if (!createRes.ok) throw new Error('建立歌單失敗');
        const playlist = await createRes.json();

        // 2. Add tracks (batch 100)
        for (let i = 0; i < uris.length; i += 100) {
          const batch = uris.slice(i, i + 100);
          const addRes = await fetch(`https://api.spotify.com/v1/playlists/${playlist.id}/tracks`, {
            method: 'POST',
            headers: {
              'Authorization': `Bearer ${accessToken}`,
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({ uris: batch })
          });
          if (!addRes.ok) throw new Error('加入歌曲失敗');
        }

        // 3. Upload cover (if provided)
        if (coverBase64) {
          await fetch(`https://api.spotify.com/v1/playlists/${playlist.id}/images`, {
            method: 'PUT',
            headers: {
              'Authorization': `Bearer ${accessToken}`,
              'Content-Type': 'image/jpeg'
            },
            body: coverBase64
          });
        }

        statusDiv.className = 'status-msg success';
        statusDiv.innerHTML = `歌單「${esc(playlistName)}」建立成功！共 ${uris.length} 首<br>
          <a href="${playlist.external_urls.spotify}" target="_blank"
             style="color:#1DB954;font-weight:600;">在 Spotify 開啟歌單</a>`;
      } catch (err) {
        statusDiv.className = 'status-msg error';
        statusDiv.textContent = err.message;
      }

      btnCreate.disabled = false;
    }
  </script>
</body>
</html>
