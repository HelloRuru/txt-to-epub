function initChain(){const e=document.getElementById("chain-select-all"),t=document.getElementById("chain-search"),n=document.getElementById("chain-selected-count"),a=document.getElementById("chain-member-list"),c=document.getElementById("btn-start-chain"),d=document.getElementById("btn-exit-chain"),i=document.getElementById("chain-step-select"),o=document.getElementById("chain-step-active"),s=document.getElementById("chain-queue"),l=document.getElementById("chain-no-books"),r=document.getElementById("chain-progress-fill"),m=document.getElementById("chain-progress-text");let p=new Set,u=[],h=new Set,b={};function y(e=""){const t=e?AppState.members.filter(t=>t.name.toLowerCase().includes(e.toLowerCase())):AppState.members;a.innerHTML=t.map(e=>`\n      <label class="member-item ${p.has(e.id)?"selected":""}" data-id="${e.id}">\n        <input type="checkbox" ${p.has(e.id)?"checked":""} data-id="${e.id}">\n        <span>${escapeHtml(e.name)}</span>\n      </label>\n    `).join(""),a.querySelectorAll('input[type="checkbox"]').forEach(e=>{e.addEventListener("change",()=>{e.checked?p.add(e.dataset.id):p.delete(e.dataset.id),g()})})}function g(){n.textContent=`已選 ${p.size} 人`,c.disabled=0===p.size,e.checked=p.size===AppState.members.length&&AppState.members.length>0,a.querySelectorAll(".member-item").forEach(e=>{e.classList.toggle("selected",p.has(e.dataset.id))})}function E(){const e=getBooks().filter(e=>"want"===e.status),t=u.length,n=h.size,a=t>0?Math.round(n/t*100):0;r.style.width=`${a}%`,m.textContent=`${n} / ${t} 完成`,l.style.display=0===e.length?"block":"none",s.innerHTML=u.map((t,n)=>{const a=h.has(t.id),c=b[t.id]||"",d=e.find(e=>e.id===c);return`\n        <div class="queue-card ${a?"done":""}">\n          <div class="queue-card-header">\n            <input type="checkbox" ${a?"checked":""} class="chain-done-cb" data-id="${t.id}"\n                   style="accent-color: var(--color-sage);">\n            <span class="queue-number">#${n+1}</span>\n            <span class="queue-name">${escapeHtml(t.name)}</span>\n          </div>\n          <div class="queue-card-body">\n            <select class="input-field chain-book-select" data-member="${t.id}">\n              <option value="">-- 選一本書 --</option>\n              ${e.map(e=>`<option value="${e.id}" ${e.id===c?"selected":""}>${escapeHtml(e.title)}</option>`).join("")}\n            </select>\n            <button class="btn-icon chain-copy-btn" data-member="${t.id}" title="複製書名"\n                    ${d?"":"disabled"}>\n              <i data-lucide="copy"></i>\n            </button>\n            <a href="${escapeHtml(t.link)}" target="_blank" rel="noopener"\n               class="btn-primary btn-sm btn-open-ap">\n              <i data-lucide="external-link"></i> AP 連結\n            </a>\n          </div>\n        </div>\n      `}).join(""),s.querySelectorAll(".chain-done-cb").forEach(e=>{e.addEventListener("change",()=>{const t=e.dataset.id;if(e.checked){h.add(t);const e=b[t];if(e){const n=getBooks(),a=n.find(t=>t.id===e);if(a&&"want"===a.status){const e=u.find(e=>e.id===t);a.status="bought",a.purchaseDate=(new Date).toISOString().split("T")[0],a.purchaseVia=e?e.name:"",saveBooks(n),showToast(`已標記購買：${a.title}`),document.dispatchEvent(new Event("books-updated"))}}}else h.delete(t);E()})}),s.querySelectorAll(".chain-book-select").forEach(e=>{e.addEventListener("change",()=>{b[e.dataset.member]=e.value,E()})}),s.querySelectorAll(".chain-copy-btn").forEach(t=>{t.addEventListener("click",()=>{const n=b[t.dataset.member],a=e.find(e=>e.id===n);a&&copyToClipboard(a.title)})}),window.lucide&&lucide.createIcons()}e.addEventListener("change",()=>{e.checked?AppState.members.forEach(e=>p.add(e.id)):p.clear(),y(t.value),g()}),t.addEventListener("input",()=>y(t.value)),c.addEventListener("click",()=>{u=Array.from(p).map(e=>AppState.members.find(t=>t.id===e)).filter(Boolean),h=new Set,b={},i.style.display="none",o.style.display="block",E()}),d.addEventListener("click",()=>{h.size<u.length&&!confirm("接龍尚未完成，確定要離開嗎？")||(i.style.display="block",o.style.display="none")}),y(),g()}function copyToClipboard(e){navigator.clipboard.writeText(e).then(()=>{showToast(`已複製：${e}`)}).catch(()=>{const t=document.createElement("textarea");t.value=e,document.body.appendChild(t),t.select(),document.execCommand("copy"),document.body.removeChild(t),showToast(`已複製：${e}`)})}window.initChain=initChain,window.copyToClipboard=copyToClipboard;