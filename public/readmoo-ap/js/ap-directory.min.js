let directoryEditMode=!1;function initDirectory(e){const t=document.getElementById("directory-list"),n=document.getElementById("directory-loading"),i=document.getElementById("directory-search"),d=document.getElementById("directory-count"),a=document.getElementById("btn-edit-directory"),r=document.getElementById("btn-export-directory");function o(e=""){const a=e?AppState.members.filter(t=>t.name.toLowerCase().includes(e.toLowerCase())||t.id.includes(e)):AppState.members;d.textContent=`共 ${a.length} 人`,n.style.display="none",0!==a.length?(t.innerHTML=a.map((e,t)=>`\n      <div class="dir-item" data-id="${e.id}">\n        <input type="checkbox" class="dir-select" data-id="${e.id}">\n        <span class="dir-number">#${e.id}</span>\n        <span class="dir-name">${escapeHtml(e.name)}</span>\n        <a href="${escapeHtml(e.link)}" target="_blank" rel="noopener" class="dir-link"\n           title="${escapeHtml(e.link)}">\n          ${escapeHtml(shortenLink(e.link))}\n        </a>\n        ${directoryEditMode?`\n          <div class="dir-actions">\n            <button class="btn-icon dir-edit-btn" data-id="${e.id}" title="編輯">\n              <i data-lucide="pencil"></i>\n            </button>\n            <button class="btn-icon dir-delete-btn" data-id="${e.id}" title="刪除">\n              <i data-lucide="trash-2"></i>\n            </button>\n          </div>\n        `:""}\n      </div>\n    `).join(""),window.lucide&&lucide.createIcons(),t.querySelectorAll(".dir-edit-btn").forEach(e=>{e.addEventListener("click",()=>{const t=e.dataset.id,n=AppState.members.find(e=>e.id===t);if(!n)return;const d=prompt("修改暱稱：",n.name);if(null===d)return;const a=prompt("修改 AP 連結：",n.link);null!==a&&async function(e,t,n){const d=AppState.members.find(t=>t.id===e),a=d.name;CONFIG.APPS_SCRIPT_URL?(await writeToSheet("edit",{id:e,name:t,link:n})).success&&(addChangelogEntry("edit",`編輯成員 #${e}：${a} → ${t}`),showToast("編輯成功"),o(i.value)):(d.name=t,d.link=n,localStorage.setItem(CONFIG.STORAGE_KEYS.AP_CACHE,JSON.stringify({data:AppState.members,time:Date.now()})),addChangelogEntry("edit",`編輯成員 #${e}：${a} → ${t}`),showToast("已在本機更新（Apps Script 未設定，無法同步到試算表）"),o(i.value))}(t,d.trim()||n.name,a.trim()||n.link)})}),t.querySelectorAll(".dir-delete-btn").forEach(e=>{e.addEventListener("click",()=>{const t=e.dataset.id,n=AppState.members.find(e=>e.id===t);n&&confirm(`確定要刪除 ${n.name} 嗎？`)&&async function(e){const t=AppState.members.find(t=>t.id===e);CONFIG.APPS_SCRIPT_URL?(await writeToSheet("delete",{id:e})).success&&(addChangelogEntry("delete",`刪除成員 #${e}：${t.name}`),showToast("刪除成功"),o(i.value)):(AppState.members=AppState.members.filter(t=>t.id!==e),localStorage.setItem(CONFIG.STORAGE_KEYS.AP_CACHE,JSON.stringify({data:AppState.members,time:Date.now()})),addChangelogEntry("delete",`刪除成員 #${e}：${t.name}`),showToast("已在本機刪除"),o(i.value))}(t)})})):t.innerHTML='<p class="empty-state">找不到符合的成員。</p>'}i.addEventListener("input",()=>o(i.value)),a.addEventListener("click",()=>{requireAuth(()=>{directoryEditMode=!directoryEditMode,a.innerHTML=directoryEditMode?'<i data-lucide="check"></i> 完成編輯':'<i data-lucide="edit"></i> 編輯名冊',window.lucide&&lucide.createIcons(),directoryEditMode&&function(){const e=document.createElement("button");e.className="btn-secondary btn-sm",e.style.marginBottom="var(--space-md)",e.innerHTML='<i data-lucide="user-plus"></i> 新增成員',e.addEventListener("click",async()=>{const e=prompt("新成員暱稱：");if(!e||!e.trim())return;const t=prompt("AP 連結（moo.im/a/...）：");if(t&&t.trim())if(CONFIG.APPS_SCRIPT_URL){(await writeToSheet("add",{name:e.trim(),link:t.trim()})).success&&(addChangelogEntry("add",`新增成員：${e.trim()}`),showToast("新增成功"),o(i.value))}else{const n=String(AppState.members.length+1);AppState.members.push({id:n,name:e.trim(),link:t.trim()}),localStorage.setItem(CONFIG.STORAGE_KEYS.AP_CACHE,JSON.stringify({data:AppState.members,time:Date.now()})),addChangelogEntry("add",`新增成員：${e.trim()}`),showToast("已在本機新增"),o(i.value)}});const t=document.querySelector(".directory-toolbar"),n=t.querySelector(".btn-add-member");n&&n.remove();e.classList.add("btn-add-member"),t.appendChild(e),window.lucide&&lucide.createIcons()}(),o(i.value)})}),r.addEventListener("click",()=>{const e=Array.from(t.querySelectorAll(".dir-select:checked")).map(e=>e.dataset.id);openExportModal("directory",e)}),o()}function escapeHtml(e){if(!e)return"";const t={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"};return e.replace(/[&<>"']/g,e=>t[e])}function shortenLink(e){return e?e.replace(/^https?:\/\//,"").substring(0,25)+(e.length>32?"...":""):""}window.initDirectory=initDirectory;