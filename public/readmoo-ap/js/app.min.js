const CONFIG={SHEET_ID:"1xjGSZquaGyLPRWsBEKtM2_1t_CRS1LLKSF76NhYzaeA",APPS_SCRIPT_URL:"https://script.google.com/macros/s/AKfycbwdRGfRb8YvPdOzewdvPZgchW8JHd6sQVL6AJ-AIjxgw41PDL4VZfZtGWYeh69cqObX/exec",STORAGE_KEYS:{BOOKS:"readmoo-ap-books",USER:"readmoo-ap-user",CHANGELOG:"readmoo-ap-changelog",AP_CACHE:"readmoo-ap-cache",THEME:"helloruru-theme",CHAIN_STATE:"readmoo-ap-chain-state"}},AppState={members:[],user:null,isVerified:!1};function initTabs(){const e=document.querySelectorAll(".tab-btn"),t=document.querySelectorAll(".tab-panel");function o(o){e.forEach(e=>{e.classList.toggle("active",e.dataset.tab===o),e.setAttribute("aria-selected",e.dataset.tab===o)}),t.forEach(e=>{e.classList.toggle("active",e.id===`tab-${o}`)}),window.location.hash=o}e.forEach(e=>{e.addEventListener("click",()=>o(e.dataset.tab))});const n=window.location.hash.slice(1);n&&document.getElementById(`tab-${n}`)&&o(n),window.addEventListener("hashchange",()=>{const e=window.location.hash.slice(1);e&&document.getElementById(`tab-${e}`)&&o(e)})}function initDarkMode(){const e=CONFIG.STORAGE_KEYS.THEME,t=document.querySelector(".theme-toggle"),o=window.matchMedia("(prefers-color-scheme: dark)");function n(e){document.documentElement.classList.toggle("dark",e)}o.addEventListener("change",t=>{localStorage.getItem(e)||n(t.matches)}),t&&t.addEventListener("click",function(){const t=!document.documentElement.classList.contains("dark");n(t),localStorage.setItem(e,t?"dark":"light")}),function(){const t=localStorage.getItem(e);n("dark"===t||"light"!==t&&o.matches)}()}function showToast(e,t=2500){const o=document.getElementById("toast");o.textContent=e,o.style.display="block",clearTimeout(o._timeout),o._timeout=setTimeout(()=>{o.style.display="none"},t)}function openModal(e){document.getElementById(e).style.display="flex"}function closeModal(e){document.getElementById(e).style.display="none"}function initModalCloses(){document.querySelectorAll(".modal-close").forEach(e=>{e.addEventListener("click",()=>{e.closest(".modal-overlay").style.display="none"})}),document.querySelectorAll(".modal-overlay").forEach(e=>{e.addEventListener("click",t=>{t.target===e&&(e.style.display="none")})})}function loadUser(){const e=localStorage.getItem(CONFIG.STORAGE_KEYS.USER);e&&(AppState.user=JSON.parse(e),AppState.isVerified=!0),updateUserBar()}function saveUser(e,t){AppState.user={name:e,date:t},AppState.isVerified=!0,localStorage.setItem(CONFIG.STORAGE_KEYS.USER,JSON.stringify(AppState.user)),updateUserBar()}function updateUserBar(){const e=document.getElementById("user-bar"),t=document.getElementById("user-bar-name");e&&(AppState.user&&AppState.user.name?(t.textContent=AppState.user.name,e.style.display="flex"):e.style.display="none")}function requireAuth(e){AppState.isVerified?e():(openModal("quiz-modal"),AppState._authCallback=e)}async function fetchMembersFromSheet(){const e=`https://docs.google.com/spreadsheets/d/${CONFIG.SHEET_ID}/gviz/tq?tqx=out:json&headers=0`;try{const t=await fetch(e),o=(await t.text()).match(/google\.visualization\.Query\.setResponse\((.+)\)/);if(!o)throw new Error("Parse error");const n=JSON.parse(o[1]).table.rows,a=[];for(let e=0;e<n.length;e++){const t=n[e].c,o=t[0]?.v,i=t[1]?.v,s=t[2]?.v;o&&i&&a.push({id:String(o),name:String(i),link:s?String(s):""})}return AppState.members=a,localStorage.setItem(CONFIG.STORAGE_KEYS.AP_CACHE,JSON.stringify({data:a,time:Date.now()})),a}catch(e){console.error("Failed to fetch from Google Sheets:",e);const t=localStorage.getItem(CONFIG.STORAGE_KEYS.AP_CACHE);if(t){const e=JSON.parse(t);return AppState.members=e.data,e.data}return[]}}async function writeToSheet(e,t){if(!CONFIG.APPS_SCRIPT_URL)return showToast("Apps Script 尚未設定，請聯繫管理員"),{success:!1};try{const o=await fetch(CONFIG.APPS_SCRIPT_URL,{method:"POST",body:JSON.stringify({action:e,editor:AppState.user?.name||"匿名",...t})}),n=await o.json();return n.success&&await fetchMembersFromSheet(),n}catch(e){return console.error("Write failed:",e),showToast("寫入失敗，請稍後再試"),{success:!1}}}function initFooter(){const e=2026,t=(new Date).getFullYear(),o=document.getElementById("footer-year");o&&(o.textContent=t>e?`2026–${t}`:"2026")}document.addEventListener("DOMContentLoaded",async()=>{initDarkMode(),initTabs(),initModalCloses(),initFooter(),loadUser(),window.lucide&&lucide.createIcons();const e=await fetchMembersFromSheet();window.initQuiz&&initQuiz(),window.initDirectory&&initDirectory(e),window.initChain&&initChain(),window.initBooks&&initBooks(),window.initChangelog&&initChangelog();const t=document.getElementById("qa-edit-link");t&&t.addEventListener("click",e=>{e.preventDefault(),window.location.hash="directory",setTimeout(()=>{const e=document.getElementById("btn-edit-directory");e&&e.click()},300)});const o=document.getElementById("btn-logout");o&&o.addEventListener("click",()=>{localStorage.removeItem(CONFIG.STORAGE_KEYS.USER),AppState.user=null,AppState.isVerified=!1,updateUserBar(),openModal("quiz-modal")})});