function getBooks(){const t=localStorage.getItem(CONFIG.STORAGE_KEYS.BOOKS);return t?JSON.parse(t):[]}function saveBooks(t){localStorage.setItem(CONFIG.STORAGE_KEYS.BOOKS,JSON.stringify(t))}function initBooks(){const t=document.getElementById("books-list"),e=document.getElementById("books-empty"),o=document.getElementById("btn-add-book"),n=document.getElementById("btn-batch-add"),a=document.getElementById("btn-export-books"),d=document.querySelectorAll(".filter-btn"),l=(document.getElementById("book-modal"),document.getElementById("btn-book-save")),i=document.getElementById("book-title"),s=document.getElementById("book-author"),c=document.getElementById("book-publisher"),u=document.getElementById("book-pubdate"),r=document.getElementById("book-edit-id"),b=document.getElementById("book-modal-title"),m=document.getElementById("book-order-number"),v=document.getElementById("book-notes"),k=(document.getElementById("batch-modal"),document.getElementById("batch-input")),p=document.getElementById("btn-batch-save"),h=(document.getElementById("purchase-modal"),document.getElementById("purchase-date")),g=document.getElementById("purchase-via"),E=document.getElementById("purchase-book-id"),B=document.getElementById("btn-purchase-save");let y="all";function f(){const o=getBooks(),n="all"===y?o:"want"===y?o.filter(t=>"want"===t.status):o.filter(t=>"bought"===t.status);e.style.display=0===n.length?"block":"none",t.style.display=0===n.length?"none":"flex",t.innerHTML=n.map(t=>`\n      <div class="book-card ${"bought"===t.status?"bought":""}" data-id="${t.id}">\n        <div class="book-info">\n          <div class="book-title">${escapeHtml(t.title)}</div>\n          <div class="book-meta">\n            ${t.author?escapeHtml(t.author):""}\n            ${t.publisher?" · "+escapeHtml(t.publisher):""}\n            ${t.pubdate?" · "+escapeHtml(t.pubdate):""}\n          </div>\n          ${"bought"===t.status?`\n            <div class="book-purchase-info">\n              <i data-lucide="check-circle"></i>\n              已購買${t.purchaseDate?" "+t.purchaseDate:""}\n              ${t.purchaseVia?" · 透過 "+escapeHtml(t.purchaseVia):""}\n            </div>\n          `:""}\n          ${t.orderNumber?`\n            <div class="book-annotation">\n              <i data-lucide="receipt"></i>\n              訂單編號 ${escapeHtml(t.orderNumber)}\n            </div>\n          `:""}\n          ${t.notes?`\n            <div class="book-annotation book-notes-text">\n              <i data-lucide="sticky-note"></i>\n              ${escapeHtml(t.notes)}\n            </div>\n          `:""}\n        </div>\n        <div class="book-actions">\n          <button class="btn-icon book-copy-btn" data-title="${escapeHtml(t.title)}" title="複製書名">\n            <i data-lucide="copy"></i>\n          </button>\n          ${"want"===t.status?`\n            <button class="btn-icon book-buy-btn" data-id="${t.id}" title="標記已購買">\n              <i data-lucide="shopping-cart"></i>\n            </button>\n          `:`\n            <button class="btn-icon book-unbuy-btn" data-id="${t.id}" title="取消購買標記">\n              <i data-lucide="undo-2"></i>\n            </button>\n          `}\n          <button class="btn-icon book-edit-btn" data-id="${t.id}" title="編輯">\n            <i data-lucide="pencil"></i>\n          </button>\n          <button class="btn-icon book-delete-btn" data-id="${t.id}" title="刪除">\n            <i data-lucide="trash-2"></i>\n          </button>\n        </div>\n      </div>\n    `).join(""),window.lucide&&lucide.createIcons(),t.querySelectorAll(".book-copy-btn").forEach(t=>{t.addEventListener("click",()=>copyToClipboard(t.dataset.title))}),t.querySelectorAll(".book-buy-btn").forEach(t=>{t.addEventListener("click",()=>{E.value=t.dataset.id,h.value=(new Date).toISOString().split("T")[0],g.innerHTML='<option value="">-- 選擇 --</option>',AppState.members.forEach(t=>{const e=document.createElement("option");e.value=t.name,e.textContent=t.name,g.appendChild(e)}),openModal("purchase-modal")})}),t.querySelectorAll(".book-unbuy-btn").forEach(t=>{t.addEventListener("click",()=>{const e=getBooks(),o=e.find(e=>e.id===t.dataset.id);o&&(o.status="want",delete o.purchaseDate,delete o.purchaseVia,saveBooks(e),showToast("已取消購買標記"),f())})}),t.querySelectorAll(".book-edit-btn").forEach(t=>{t.addEventListener("click",()=>{const e=getBooks().find(e=>e.id===t.dataset.id);e&&(b.textContent="編輯書籍",i.value=e.title,s.value=e.author||"",c.value=e.publisher||"",u.value=e.pubdate||"",m.value=e.orderNumber||"",v.value=e.notes||"",r.value=e.id,openModal("book-modal"))})}),t.querySelectorAll(".book-delete-btn").forEach(t=>{t.addEventListener("click",()=>{if(!confirm("確定刪除這本書嗎？"))return;let e=getBooks();e=e.filter(e=>e.id!==t.dataset.id),saveBooks(e),showToast("已刪除"),f()})})}d.forEach(t=>{t.addEventListener("click",()=>{d.forEach(t=>t.classList.remove("active")),t.classList.add("active"),y=t.dataset.filter,f()})}),o.addEventListener("click",()=>{b.textContent="新增書籍",i.value="",s.value="",c.value="",u.value="",m.value="",v.value="",r.value="",openModal("book-modal")}),l.addEventListener("click",()=>{const t=i.value.trim();if(!t)return void showToast("請輸入書名");const e=getBooks(),o=r.value;if(o){const n=e.find(t=>t.id===o);n&&(n.title=t,n.author=s.value.trim(),n.publisher=c.value.trim(),n.pubdate=u.value.trim(),n.orderNumber=m.value.trim(),n.notes=v.value.trim()),showToast("已更新")}else e.push({id:"book_"+Date.now(),title:t,author:s.value.trim(),publisher:c.value.trim(),pubdate:u.value.trim(),orderNumber:m.value.trim(),notes:v.value.trim(),status:"want",createdAt:(new Date).toISOString()}),showToast("已新增");saveBooks(e),closeModal("book-modal"),f()}),n.addEventListener("click",()=>{k.value="",openModal("batch-modal")}),p.addEventListener("click",()=>{const t=k.value.split("\n").map(t=>t.trim()).filter(Boolean);if(0===t.length)return void showToast("請輸入至少一本書名");const e=getBooks();t.forEach(t=>{e.push({id:"book_"+Date.now()+"_"+Math.random().toString(36).substring(2,6),title:t,author:"",publisher:"",pubdate:"",status:"want",createdAt:(new Date).toISOString()})}),saveBooks(e),closeModal("batch-modal"),showToast(`已新增 ${t.length} 本書`),f()}),B.addEventListener("click",()=>{const t=E.value,e=getBooks(),o=e.find(e=>e.id===t);o&&(o.status="bought",o.purchaseDate=h.value,o.purchaseVia=g.value,saveBooks(e),closeModal("purchase-modal"),showToast("已標記為已購買"),f())}),a.addEventListener("click",()=>{openExportModal("books",[])}),window._booksRender=f,document.addEventListener("books-updated",f),f()}window.initBooks=initBooks,window.getBooks=getBooks;