let exportContext={type:"",selectedIds:[]};function openExportModal(e,t){exportContext={type:e,selectedIds:t};const o=document.getElementById("export-modal-title"),n=document.getElementById("export-scope"),r=document.getElementById("export-preview");o.textContent="directory"===e?"匯出 AP 名冊":"匯出書單",n.style.display="directory"===e?"flex":"none",r.style.display="none",document.querySelectorAll(".export-btn").forEach(e=>e.classList.remove("active")),openModal("export-modal")}function initExportHandlers(){const e=document.getElementById("export-preview"),t=document.getElementById("export-text"),o=document.getElementById("btn-copy-export");document.querySelectorAll(".export-btn").forEach(o=>{o.addEventListener("click",()=>{document.querySelectorAll(".export-btn").forEach(e=>e.classList.remove("active")),o.classList.add("active");const n=o.dataset.format,r=document.querySelector('input[name="export-scope"]:checked')?.value||"all";if("line"===n){const o=generateLineMessage(exportContext.type,r);t.value=o,e.style.display="block"}else if("text"===n){const o=generateText(exportContext.type,r);t.value=o,e.style.display="block"}else"excel"===n&&(generateExcel(exportContext.type,r),e.style.display="none")})}),o.addEventListener("click",()=>{t.select(),navigator.clipboard.writeText(t.value).then(()=>{showToast("已複製到剪貼簿")})})}function generateText(e,t){if("directory"===e){let e=AppState.members;if("selected"===t&&exportContext.selectedIds.length>0){const t=new Set(exportContext.selectedIds);e=e.filter(e=>t.has(e.id))}return["讀墨1500日挑戰 AP 名冊",`匯出日期：${(new Date).toLocaleDateString("zh-TW")}`,`共 ${e.length} 人`,"─────────────────",...e.map((e,t)=>`${e.id}. ${e.name} — ${e.link}`)].join("\n")}{const e=getBooks();return["我的書單",`匯出日期：${(new Date).toLocaleDateString("zh-TW")}`,`共 ${e.length} 本`,"─────────────────",...e.map(e=>{let t=`${"bought"===e.status?"[已購買]":"[想  買]"} ${e.title}`;return e.author&&(t+=` / ${e.author}`),e.purchaseVia&&(t+=` (透過 ${e.purchaseVia})`),e.orderNumber&&(t+=` [訂單: ${e.orderNumber}]`),e.notes&&(t+=` — ${e.notes}`),t})].join("\n")}}function generateExcel(e,t){if("undefined"==typeof XLSX)return void showToast("Excel 套件載入中，請稍後再試");const o=(new Date).toISOString().split("T")[0].replace(/-/g,"");let n,r;if("directory"===e){let e=AppState.members;if("selected"===t&&exportContext.selectedIds.length>0){const t=new Set(exportContext.selectedIds);e=e.filter(e=>t.has(e.id))}const s=[["編號","暱稱","AP 連結"],...e.map(e=>[e.id,e.name,e.link])];n=XLSX.utils.book_new();const l=XLSX.utils.aoa_to_sheet(s);l["!cols"]=[{wch:6},{wch:20},{wch:30}],XLSX.utils.book_append_sheet(n,l,"AP名冊"),r=`AP名冊_${o}.xlsx`}else{const e=[["書名","作者","出版社","出版日期","狀態","購買日期","AP 夥伴","訂單編號","備註"],...getBooks().map(e=>[e.title,e.author||"",e.publisher||"",e.pubdate||"","bought"===e.status?"已購買":"想買",e.purchaseDate||"",e.purchaseVia||"",e.orderNumber||"",e.notes||""])];n=XLSX.utils.book_new();const t=XLSX.utils.aoa_to_sheet(e);t["!cols"]=[{wch:30},{wch:15},{wch:12},{wch:12},{wch:8},{wch:12},{wch:15},{wch:18},{wch:25}],XLSX.utils.book_append_sheet(n,t,"我的書單"),r=`書單_${o}.xlsx`}XLSX.writeFile(n,r),showToast(`已下載 ${r}`),closeModal("export-modal")}function maskOrderNumber(e){const t=String(e).replace(/\D/g,"");if(0===t.length)return"***";return"*"+t.slice(-3).slice(-2)}function generateLineMessage(e,t){if("directory"===e){let e=AppState.members;if("selected"===t&&exportContext.selectedIds.length>0){const t=new Set(exportContext.selectedIds);e=e.filter(e=>t.has(e.id))}return["AP 接龍名單",`${(new Date).toLocaleDateString("zh-TW")}`,"",...e.map((e,t)=>`${t+1}. @${e.name}`),"",`共 ${e.length} 人`].join("\n")}const o=getBooks().filter(e=>"bought"===e.status);if(0===o.length)return"還沒有已購買的書喔！";const n={},r=[];o.forEach(e=>{if(e.orderNumber){const t=e.orderNumber;n[t]||(n[t]=[]),n[t].push(e)}else r.push(e)});const s=[];return Object.keys(n).forEach(e=>{const t=n[e],o=maskOrderNumber(e),r=t.map(e=>e.purchaseVia?`@${e.purchaseVia}`:"").filter(Boolean),l=[...new Set(r)];s.push(`訂單編號${o} ${l.join(" ")}`)}),r.length>0&&(s.length>0&&s.push(""),r.forEach(e=>{let t=e.title;e.purchaseVia&&(t+=`（@${e.purchaseVia}）`),s.push(t)})),s.join("\n")}document.addEventListener("DOMContentLoaded",()=>{initExportHandlers()}),window.openExportModal=openExportModal;