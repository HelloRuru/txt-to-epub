function initReadmooSearch(){const e=document.getElementById("btn-search-readmoo"),t=document.getElementById("readmoo-search-panel"),a=document.getElementById("readmoo-search-input"),n=document.getElementById("btn-readmoo-go"),o=document.getElementById("readmoo-search-status"),s=document.getElementById("readmoo-search-results"),r=document.querySelectorAll(".search-mode-btn");let i=!1,c=null,d="title";async function l(){const e=a.value.trim();if(e){o.style.display="block",o.innerHTML='<div class="spinner-sm"></div> 正在搜尋讀墨...',s.innerHTML="";try{"localhost"===location.hostname||location.hostname;const t=await fetch(`/api/readmoo-search?q=${encodeURIComponent(e)}`);if(!t.ok){const e=await t.json().catch(()=>({}));throw new Error(e.error||`HTTP ${t.status}`)}const a=await t.json(),n="HIT"===t.headers.get("X-Cache");let r=a.books;if("author"===d&&r.length>0){const t=e.toLowerCase();r=r.filter(e=>e.author&&e.author.toLowerCase().includes(t))}else if("title"===d&&r.length>0){const t=e.toLowerCase();r=r.filter(e=>e.title&&e.title.toLowerCase().includes(t))}if(0===r.length)return void(o.innerHTML='試試其他關鍵字？又或是試試這個工具，查查這本書有沒有電子書：<a href="https://taiwan-ebook-lover.github.io/" target="_blank" rel="noopener">台灣電子書搜尋</a>');const i="author"===d?"作者":"書名";o.innerHTML=`${i}「${escapeHtml(e)}」找到 ${r.length} 本${n?' <span class="cache-badge">快取</span>':""}`,function(e){const t=getBooks(),a=new Set(t.map(e=>e.title.toLowerCase()));s.innerHTML=e.map(e=>{const t=a.has(e.title.toLowerCase());return`\n        <div class="rm-result-card">\n          <div class="rm-result-cover">\n            ${e.cover?`<img src="${escapeHtml(e.cover)}" alt="${escapeHtml(e.title)}" loading="lazy">`:'<div class="rm-no-cover"><i data-lucide="book"></i></div>'}\n          </div>\n          <div class="rm-result-info">\n            <div class="rm-result-title">${escapeHtml(e.title)}</div>\n            <div class="rm-result-meta">\n              ${e.author?escapeHtml(e.author):""}\n              ${e.publisher?" · "+escapeHtml(e.publisher):""}\n            </div>\n            <div class="rm-result-price">\n              ${e.price?`NT$ ${e.price}`:""}\n            </div>\n          </div>\n          <div class="rm-result-actions">\n            ${t?'<span class="rm-already-added"><i data-lucide="check"></i> 已在書單</span>':`<button class="btn-primary btn-sm rm-add-btn"\n                   data-title="${escapeHtml(e.title)}"\n                   data-author="${escapeHtml(e.author||"")}"\n                   data-publisher="${escapeHtml(e.publisher||"")}"\n                   data-price="${e.price||""}"\n                   data-cover="${escapeHtml(e.cover||"")}"\n                   data-url="${escapeHtml(e.url||"")}">\n                  <i data-lucide="plus"></i> 加入書單\n                </button>`}\n            <a href="${escapeHtml(e.url)}" target="_blank" rel="noopener" class="btn-secondary btn-sm">\n              <i data-lucide="external-link"></i>\n            </a>\n          </div>\n        </div>\n      `}).join(""),window.lucide&&lucide.createIcons();s.querySelectorAll(".rm-add-btn").forEach(e=>{e.addEventListener("click",()=>{const t=getBooks();t.push({id:"book_"+Date.now(),title:e.dataset.title,author:e.dataset.author,version:"電子書",pubdate:"",publisher:e.dataset.publisher,price:e.dataset.price,cover:e.dataset.cover,readmooUrl:e.dataset.url,status:"want",createdAt:(new Date).toISOString()}),saveBooks(t),e.outerHTML='<span class="rm-already-added"><i data-lucide="check"></i> 已在書單</span>',window.lucide&&lucide.createIcons(),showToast(`已加入書單：${e.dataset.title}`),window.initBooks&&document.getElementById("books-list")&&document.dispatchEvent(new Event("books-updated"))})})}(r)}catch(e){o.innerHTML=`<span class="search-error">搜尋失敗：${escapeHtml(e.message)}</span>`}}else showToast("author"===d?"請輸入作者名":"請輸入書名")}r.forEach(e=>{e.addEventListener("click",()=>{r.forEach(e=>e.classList.remove("active")),e.classList.add("active"),d=e.dataset.mode,a.placeholder="author"===d?"輸入作者名...":"輸入書名...",a.focus()})}),e.addEventListener("click",()=>{i=!i,t.style.display=i?"block":"none",i&&a.focus()}),a.addEventListener("input",()=>{clearTimeout(c);a.value.trim().length>=2&&(c=setTimeout(l,300))}),a.addEventListener("keydown",e=>{"Enter"===e.key&&(clearTimeout(c),l())}),n.addEventListener("click",()=>{clearTimeout(c),l()})}document.addEventListener("DOMContentLoaded",()=>{document.getElementById("readmoo-search-panel")&&initReadmooSearch()}),document.addEventListener("books-updated",()=>{window._booksRender&&window._booksRender()}),window.initReadmooSearch=initReadmooSearch;